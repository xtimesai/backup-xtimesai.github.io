{{- $description := "" }}
{{- $title := "" }}

{{- if eq .Kind "taxonomyTerm" }}
  {{- $mostUsed := slice }}
  {{- range $key, $value := .Data.Terms.ByCount }}
    {{- $mostUsed = $mostUsed | append $value.Name }}
  {{- end }}
  
  {{- if len $mostUsed }}
    {{- $description = printf "A full overview of all pages with %s, ordered by %s, such as: %s" .Data.Plural .Data.Singular ( delimit $mostUsed ", " ", and " ) | truncate 180 }}
  {{- else }}
    {{- $description = printf "A full overview of all pages with %s, ordered by %s" .Data.Plural .Data.Singular | truncate 180 }}
  {{- end }}
  
  {{- $title = printf "Overview of all pages with %s, ordered by %s" .Data.Plural .Data.Singular }}

{{- else if eq .Kind "taxonomy" }}
  {{- $firstPageTitle := "" }}
  {{- if .Pages }}
    {{- $firstPageTitle = (index .Pages 0).Title }}
  {{- end }}
  
  {{- $description = printf "Overview of all pages with the %s #%s, such as: %s" .Data.Singular $.Title $firstPageTitle | truncate 160 }}
  {{- $title = printf "Overview of all pages with the %s #%s" .Data.Singular $.Title }}

{{- else }}
  {{- $description = .Description | default .Params.subtitle | default .Summary }}
  {{- $title = .Title | default .Site.Title }}
{{- end }}

<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang }}">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Title, Description, Author, and Favicon -->
    {{ if .IsHome }}
        <title>{{ .Site.Title }}</title>
        {{ with .Site.Params.description }}
            <meta name="description" content="{{ . }}">
        {{ end }}
    {{ else }}
        <title>{{ $title }} - {{ .Site.Title }}</title>
        {{ with $description }}
            <meta name="description" content="{{ . }}">
        {{ end }}
    {{ end }}

    {{ with .Site.Params.Author.name }}
        <meta name="author" content="{{ . }}">
    {{ end }}

    {{- partial "seo/main.html" . -}}

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ "favicon/apple-touch-icon.png" | absURL }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ "favicon/favicon-32x32.png" | absURL }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ "favicon/favicon-16x16.png" | absURL }}">

    <!-- Hugo Version -->
    {{ hugo.Generator }}

    <!-- RSS -->
    <link rel="alternate" href="{{ "index.xml" | absLangURL }}" type="application/rss+xml" title="{{ .Site.Title }}">

    <!-- Dark Mode Script -->
    <script src="{{ "js/dark-mode.js" | absURL }}"></script>

    <!-- Lunr Search Integration -->
    {{- if .Site.Params.lunrSearch -}}
        {{- $lunrConfig := .Site.Params.lunrSearch -}}
        
        {{- if $lunrConfig.enabled -}}
            {{- $selfHosted := $lunrConfig.selfHosted | default false -}}
            
            {{- if $selfHosted -}}
                <script src="{{ "vendor/lunr/lunr.min.js" | absURL }}"></script>
            {{- else -}}
                <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js" 
                        integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli" 
                        crossorigin="anonymous"></script>
            {{- end -}}

            {{- $lang := substr .Site.Language.Lang 0 2 -}}
            {{- $searchScript := resources.Get "js/lunr-search.js" -}}
            {{- $searchIndex := resources.Get "json/search.json" -}}
            
            {{- if and $searchScript $searchIndex -}}
                {{- $processedIndex := $searchIndex | resources.ExecuteAsTemplate "search.json" . -}}
                <script src="{{ $searchScript.RelPermalink }}" 
                        data-index="{{ $processedIndex.RelPermalink }}"></script>
            {{- end -}}
        {{- end -}}
    {{- end -}}

    <!-- CSS Processing -->
    {{- $scssOptions := dict "includePaths" (slice "static/vendor/bootstrap/css" "static/vendor/bootstrap-icons") -}}
    {{- $scss := resources.Get "css/main.scss" -}}
    {{- if $scss -}}
        {{- $style := $scss | resources.ExecuteAsTemplate "style.scss" . | toCSS $scssOptions -}}
        {{- if $style -}}
            <link rel="stylesheet" href="{{ ($style | minify).RelPermalink }}">
        {{- end -}}
    {{- end -}}

    <!-- GLightbox -->
    <link href="/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <script src="{{ "vendor/glightbox/js/glightbox.min.js" | absURL }}"></script>

    <!-- Custom Head and Analytics -->
    {{- partial "head_custom.html" . -}}
    {{ template "_default/google_analytics_async.html" . }}
</head>
</html>